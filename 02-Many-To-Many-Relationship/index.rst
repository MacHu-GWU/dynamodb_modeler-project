Many to Many Relationship in DynamoDB
==============================================================================


Overview
------------------------------------------------------------------------------
本文将详细的讨论 Many to Many 的关系在 DynamoDB 中的实现, 以及各种方案的优缺点以及应用场景.


A Simple Example - Video and Playlist
------------------------------------------------------------------------------
我们来考虑下面这个例子:

Youtube 视频网站上有很多 Video. 用户可以创建 Playlist 来管理这些 Video.

Reference:

- Sample Data: https://docs.google.com/spreadsheets/d/1PG2YyBoH2NoPyhcGhweARX2XdbRlh8-EEH9YD4IidHU/edit#gid=920901529


How To Evaluate the Effectiveness of a Data Model
------------------------------------------------------------------------------
Data Model 是要为业务服务的. 在实际应用中, 跟 Many to Many 相关的业务逻辑主要有下面 3 种:

1. 关联变更: 需要将每个 Many Entity 和一个 Many Entity 关联起来. 这个关联关系可能会变化.
2. 双向查询实体: 给定一个 entity, 查询与之对应的多个 entity.
3. 一个 Entity 有多个 O2M 关系: 有时候一个 Entity 和多个 Entity 之间都有 Many to Many 的关系.


Method 1
------------------------------------------------------------------------------
.. code-block::

    +-------------------------------------+--+-------------------------------------------+--+-------------------------------------------+
    |            Table (video)            |  |              Table (playlist)             |  |          GSI (playlist and video)         |
    +--------------------+-------+--------+--+--------------------+----------+-----------+--+--------------------+---------------+------+
    | pk (partition_key) |  type |  name  |  | pk (partition_key) |   type   |    name   |  | pk (partition_key) | sk (sort_key) | type |
    +--------------------+-------+--------+--+--------------------+----------+-----------+--+--------------------+---------------+------+
    |         v-1        | video | video1 |  |         p-1        | playlist | playlist1 |  |       v-1_p-v      |    p-1_p-v    |  p-v |
    +--------------------+-------+--------+--+--------------------+----------+-----------+--+--------------------+---------------+------+
    |         v-2        | video | video2 |  |         p-2        | playlist | playlist2 |  |       v-2_p-v      |    p-1_p-v    |  p-v |
    +--------------------+-------+--------+--+--------------------+----------+-----------+--+--------------------+---------------+------+
    |         v-3        | video | video3 |  |                    |          |           |  |       v-2_p-v      |    p-2_p-v    |  p-v |
    +--------------------+-------+--------+--+--------------------+----------+-----------+--+--------------------+---------------+------+
    |                    |       |        |  |                    |          |           |  |       v-3_p-v      |    p-2_p-v    |  p-v |
    +--------------------+-------+--------+--+--------------------+----------+-----------+--+--------------------+---------------+------+

Reference:

- Google Sheet: https://docs.google.com/spreadsheets/d/1PG2YyBoH2NoPyhcGhweARX2XdbRlh8-EEH9YD4IidHU/edit#gid=920901529


Method 2
------------------------------------------------------------------------------
这种方式是将关系的属性以 denormalized 的方式作为一个列表属性保存下来. 但这样做存在三个问题:

1. 如果对应的关系数量很多, 可能会超过 DynamoDB 的 item 大小上限.
2. 如果有多套 many-to-many 关系, 你肯定不能无脑创建新的 attribute. 这种方式不 scale.
3. 当关系发生变更的时候, 你要更新两个 item.

.. code-block::

    +-----------------------------------------------------+--+-----------------------------------------------------------+
    |                    Table (video)                    |  |                      Table (playlist)                     |
    +--------------------+-------+--------+---------------+--+--------------------+----------+-----------+---------------+
    | pk (partition_key) |  type |  name  |  foreign_keys |  | pk (partition_key) |   type   |    name   |  foreign_keys |
    +--------------------+-------+--------+---------------+--+--------------------+----------+-----------+---------------+
    |         v-1        | video | video1 |      p-1      |  |         p-1        | playlist | playlist1 |    v-1,v-2    |
    +--------------------+-------+--------+---------------+--+--------------------+----------+-----------+---------------+
    |         v-2        | video | video2 |    p-1,p-2    |  |         p-2        | playlist | playlist2 |    v-2,v-3    |
    +--------------------+-------+--------+---------------+--+--------------------+----------+-----------+---------------+
    |         v-3        | video | video3 |      p-2      |  |                    |          |           |               |
    +--------------------+-------+--------+---------------+--+--------------------+----------+-----------+---------------+

Reference:

- Google Sheet: https://docs.google.com/spreadsheets/d/1PG2YyBoH2NoPyhcGhweARX2XdbRlh8-EEH9YD4IidHU/edit#gid=2116210569


Method 3 (Recommended)
------------------------------------------------------------------------------
.. code-block::

    +-----------------------------------------------------------+--+--------------------------------------------+
    |                       Table (entity)                      |  |             GSI (relationship)             |
    +--------------------+---------------+----------+-----------+--+--------------------+---------+------+------+
    | pk (partition_key) | sk (sort_key) |   type   |    name   |  | sk (partition_key) |    pk   | type | name |
    +--------------------+---------------+----------+-----------+--+--------------------+---------+------+------+
    |         v-1        |    __root__   |   video  |   video1  |  |                    |         |      |      |
    +--------------------+---------------+----------+-----------+--+--------------------+---------+------+------+
    |         v-2        |    __root__   |   video  |   video2  |  |                    |         |      |      |
    +--------------------+---------------+----------+-----------+--+--------------------+---------+------+------+
    |         v-3        |    __root__   |   video  |   video3  |  |                    |         |      |      |
    +--------------------+---------------+----------+-----------+--+--------------------+---------+------+------+
    |         p-1        |    __root__   | playlist | playlist1 |  |                    |         |      |      |
    +--------------------+---------------+----------+-----------+--+--------------------+---------+------+------+
    |         p-2        |    __root__   | playlist | playlist2 |  |                    |         |      |      |
    +--------------------+---------------+----------+-----------+--+--------------------+---------+------+------+
    |       p-1_p-v      |    v-1_p-v    |    p-v   |           |  |       v-1_p-v      | p-1_p-v |      |      |
    +--------------------+---------------+----------+-----------+--+--------------------+---------+------+------+
    |       p-1_p-v      |    v-2_p-v    |    p-v   |           |  |       v-2_p-v      | p-1_p-v |      |      |
    +--------------------+---------------+----------+-----------+--+--------------------+---------+------+------+
    |       p-2_p-v      |    v-2_p-v    |    p-v   |           |  |       v-2_p-v      | p-2_p-v |      |      |
    +--------------------+---------------+----------+-----------+--+--------------------+---------+------+------+
    |       p-2_p-v      |    v-3_p-v    |    p-v   |           |  |       v-3_p-v      | p-2_p-v |      |      |
    +--------------------+---------------+----------+-----------+--+--------------------+---------+------+------+

Reference:

- Google Sheet: https://docs.google.com/spreadsheets/d/1PG2YyBoH2NoPyhcGhweARX2XdbRlh8-EEH9YD4IidHU/edit#gid=838544721


Reference
------------------------------------------------------------------------------
- `Google Sheet <https://docs.google.com/spreadsheets/d/1PG2YyBoH2NoPyhcGhweARX2XdbRlh8-EEH9YD4IidHU/edit#gid=460890669>`_
